#ifndef OBJECTS_INL_H_
#error "Direct inclusion of this file is not allowed, include objects.h"
#include "objects.h"
#endif

{%- set snapshot = snapshots[snapshot_name] %}

{% if snapshot.cpp_namespace -%}
namespace {{ snapshot.cpp_namespace }} {
{%- endif %}

{%- for object in snapshot.objects %}

////////////////////////////////////////////////////////////////////////////////

inline {{ object.cpp_key_type }}::{{ object.cpp_key_type }}(
    {%- for field in object.key_fields %}
    {{ field.cpp_type }} {{ field.lower_camel_case_name }}{% if not loop.last %}, {% endif %}
    {%- endfor %})
    {%- for field in object.key_fields %}
    {% if loop.first %}    :{% else %}    ,{% endif %} {{ field.camel_case_name }}_(std::move({{ field.lower_camel_case_name }}))
    {%- endfor %}
{ }

{%- for field in object.key_fields %}

inline ::NYT::NOrm::NSnapshot::TObjectFieldGetterReturn<{{ field.cpp_type }}> {{ object.cpp_key_type }}::{{ field.camel_case_name }}() const
{
    return {{ field.camel_case_name }}_;
}

{%- endfor %}

inline ::NYT::NOrm::NClient::NObjects::TObjectKey {{ object.cpp_key_type }}::ToObjectKey() const
{
    return ::NYT::NOrm::NClient::NObjects::TObjectKey({
        {%- for field in object.key_fields -%}
        {{ field.camel_case_name }}_{% if not loop.last %}, {% endif %}
        {%- endfor %}});
}

inline bool operator==(const {{ object.cpp_key_type }}& lhs, const {{ object.cpp_key_type }}& rhs)
{
    return
        {%- for field in object.key_fields %}
        lhs.{{ field.camel_case_name }}_ == rhs.{{ field.camel_case_name }}_{% if not loop.last %} &&{% endif %}
        {%- endfor %};
}

inline std::strong_ordering operator<=>(const {{ object.cpp_key_type }}& lhs, const {{ object.cpp_key_type }}& rhs)
{
    {%- for field in object.key_fields %}
    if (auto ordering = ::NYT::NOrm::NSnapshot::Compare(lhs.{{ field.camel_case_name }}_, rhs.{{ field.camel_case_name }}_); ordering != std::strong_ordering::equal) {
        return ordering;
    }
    {% endfor %}
    return std::strong_ordering::equal;
}

inline void FormatValue(::NYT::TStringBuilderBase* builder, const {{ object.cpp_key_type }}& key, TStringBuf /*spec*/)
{
    Format(builder,
        "{{ object.cpp_key_type }}{
            {%- for field in object.key_fields -%}
            {% if not loop.first %}, {% endif %}{{ field.snake_case_name }}=%v
            {%- endfor -%}
        }",
        {%- for field in object.key_fields %}
        key.{{ field.camel_case_name }}_{% if not loop.last %},{% endif %}
        {%- endfor %});
}

{%- endfor %}

{%- for object in snapshot.objects %}

////////////////////////////////////////////////////////////////////////////////

inline {{ object.cpp_data_type }}::{{ object.cpp_data_type }}(
    {%- for field in object.all_fields %}
    {{ field.cpp_type }} {{ field.lower_camel_case_name }}{% if not loop.last %}, {% endif %}
    {%- endfor %})
    {%- for field in object.all_fields %}
    {% if loop.first %}    :{% else %}    ,{% endif %} {{ field.camel_case_name }}_(std::move({{ field.lower_camel_case_name }}))
    {%- endfor %}
{ }

{%- for field in object.all_fields %}

inline ::NYT::NOrm::NSnapshot::TObjectFieldGetterReturn<{{ field.cpp_type }}> {{ object.cpp_data_type }}::{{ field.camel_case_name }}() const
{
    return {{ field.camel_case_name }}_;
}

{%- endfor %}

inline {{ object.cpp_key_type }} {{ object.cpp_data_type }}::Key() const
{
    return {{ object.cpp_key_type }}(
        {%- for field in object.key_fields %}
        {{ field.camel_case_name }}_{% if not loop.last %}, {% endif %}
        {%- endfor %});
}

{%- for reference in object.many_to_one_references %}

inline {{ reference.cpp_key_getter_return_type }} {{ object.cpp_data_type }}::{{ reference.camel_case_name }}Key() const
{
    {%- for field in reference.local_fields %}
    {%- if field.optional or field.falsy_value_is_invalid_reference %}
    if (!{{ field.camel_case_name }}_) {
        return std::nullopt;
    }
    {% endif %}
    {%- endfor %}
    return {{ reference.remote_object.cpp_key_type }}(
        {%- for field in reference.local_fields -%}
        {% if field.optional %}*{% endif %}{{ field.camel_case_name }}_{% if not loop.last %},{% endif %}
        {%- endfor %});
}

{%- endfor %}

{%- endfor %}

{%- for object in snapshot.objects %}

////////////////////////////////////////////////////////////////////////////////

inline {{ object.cpp_type }}::{{ object.cpp_type }}({{ object.cpp_data_ptr_type }} objectData, TSnapshotDataPtr snapshotData)
    : ObjectData_(std::move(objectData))
    , SnapshotData_(std::move(snapshotData))
{ }

{%- for field in object.all_fields %}

inline ::NYT::NOrm::NSnapshot::TObjectFieldGetterReturn<{{ field.cpp_type }}> {{ object.cpp_type }}::{{ field.camel_case_name }}() const
{
    return ObjectData_->{{ field.camel_case_name }}();
}

{%- endfor %}

inline {{ object.cpp_key_type }} {{ object.cpp_type }}::Key() const
{
    return ObjectData_->Key();
}

{%- for reference in object.many_to_one_references %}

inline {{ reference.cpp_key_getter_return_type }} {{ object.cpp_type }}::{{ reference.camel_case_name }}Key() const
{
    return ObjectData_->{{ reference.camel_case_name }}Key();
}

{%- endfor %}

{%- for reference in object.many_to_one_references %}

inline auto {{ object.cpp_type }}::{{ reference.camel_case_name }}() const
{
    return ::NYT::NOrm::NSnapshot::ResolveManyToOneReference<
        TSnapshotDescription,
        {{ reference.remote_object.cpp_type }}>
    (
        SnapshotData_,
        {{ reference.camel_case_name }}Key()
    );
}

{%- endfor %}

{%- for reference in object.one_to_many_references %}

inline auto {{ object.cpp_type }}::{{ reference.camel_case_name }}() const
{
    return ::NYT::NOrm::NSnapshot::ResolveOneToManyReference<
        TSnapshotDescription,
        {{ reference.remote_object.cpp_type }},
        T{{ object.camel_case_name }}{{ reference.camel_case_name }}Reference>
    (
        SnapshotData_,
        Key()
    );
}

{%- endfor %}

{%- endfor %}

////////////////////////////////////////////////////////////////////////////////

{% if snapshot.cpp_namespace -%}
} // namespace {{ snapshot.cpp_namespace }}
{%- endif %}
